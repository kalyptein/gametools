<html>
  <head>
    <title>Ages of History</title>
    <style>
      tr:nth-child(odd) {
        background-color: lightgrey; /* Light grey for odd rows */
      }

      /* tr:nth-child(even) {
        background-color: white; /* White for even rows
      } */

      th {
        text-align: start;
        padding: 5px
      }

      .container {
        display: flex
      }

      /* .column {
        flex: 1
      } */
    </style>
  </head>
  <body>
    <h1>History</h1>

    Seed: <input type="text" id="seedText"></input>

    <div class="container">

      <div class="column" style="width: 55%">
        <h2>Ages of History</h2>
        
        <p style="background: lightgrey; padding: 5px;">
          <button id="genButton" style="width:90px">Append Age</button>
          <button id="upButton" style="width:30px" onclick="shiftEntry(-1, true)">â–²</button>
          <button id="downButton" style="width:30px" onclick="shiftEntry(1, false)">â–¼</button>
          <button id="nextButton" style="width:90px" onclick="relatedAge(event, 'to')">Next Age</button>
          <button id="prevButton" style="width:90px" onclick="relatedAge(event, 'from')">Prior Age</button>
          <button id="rmButton" style="width:90px" onclick="removeAge(event)">Remove</button> 
          <button id="clrButton" style="width:90px" onclick="if (confirm('Clear List?')) { clearAges() }">Clear</button>
          <input type="checkbox" id="noStrangeCheck" value="false" onclick="noStrangeToggle(event)" />No Strange
          <button id="exportButton" style="width:60px; margin-left: 30px;" onclick="showIO()">I / O</button>
        </p>
        <table id="agesTable" style="border: 1px solid; border-spacing: 2px 4px">
          <tr style="background: black; color: white">
            <th style="width:30px;"></th>
            <th style="width:100px;">Age</th>
            <th style="width:100px;"></th>
            <th style="width:500px;">Description</th>
            <th style="width:500px;">Notes</th>
          </tr>
        </table>
      </div>

      <div class="column" style="width: 40%; margin-left: 50px">
        <h2>Historical Events</h2>

        <p style="background: lightgrey; padding: 5px;">
          <button id="eventButton" style="width:80px" onclick="rollEvent();">Event</button>
          <button id="crisisButton" style="width:80px" onclick="rollCrisis();">Crisis</button>
        </p>

        <ul>
          <li><button disabled onclick="copyTag(getTag('eventSpan'))">&lt;</button> Event: <span id="eventSpan"></span></li>
          <ul hidden>
            <li id="eventDescLi"></li>
          </ul>
          <li><button disabled class="crisisButtons" onclick="copyTag(getTag('crisisSpan'))">&lt;</button> Crisis: <span id="crisisSpan"></span></li>
          <ul>
            <li><button disabled class="crisisButtons" onclick="copyTag(`${getTag('crisisSpan')} (overcome: ${getTag('overcomeSpan')})`)">&lt;</button> Overcome: <span id="overcomeSpan"></span></li>
            <li><button disabled class="crisisButtons" onclick="copyTag(`${getTag('crisisSpan')} (failed: ${getTag('failSpan')})`)">&lt;</button> Failed: <span id="failSpan"></span></li>
          </ul>
        </ul>
      </div>

    </div>

    <dialog id="portDialog">
      Import / Export
      <p>
        <input type="radio" name="porttype" value="csv" checked onclick="document.getElementById('ioTextArea').value = portState('csv')" />CSV
        <input type="radio" name="porttype" value="json" onclick="document.getElementById('ioTextArea').value = portState('json')" />JSON
      </p>
      <div>
        <textarea id="ioTextArea" rows="10"></textarea> 
        <button id="clipboardButton" style="width:40px" onclick="clipboardState()" style="vertical-align: top;">ðŸ“‹</button>
      </div>
      <p>
        <button id="importButton" style="width:60px" onclick="document.getElementById('portDialog').close()">Close</button>
      </p>
    </dialog>

    <script type="module" defer>

      import * as util from "../scripts/utils.js"
      import { tables, pick } from "../scripts/utils.js"
      import { history, ageList, strangeList } from "./history.js"

      const seedText = document.getElementById("seedText")
      seedText.value = util.m.seed
      seedText.addEventListener('change', event => { util.seed(Number(seedText.value)) })

      // get elements
      const agesTable = document.getElementById("agesTable")
      const genButton = document.getElementById("genButton")
      const nextButton = document.getElementById("nextButton")
      const prevButton = document.getElementById("prevButton")

      let ha = tables['historical-ages']
      let genTooltip = `range: ${ha.indexRange}\n`
      ha.content.forEach(a => genTooltip += `${String(a.index).padEnd(10)}\t${a.key.padEnd(20)}${a.description}\n`)
      genButton.setAttribute('title', genTooltip)

      window.showIO = () => {
        document.getElementById('ioTextArea').value = portState(util.getRadioSelected('porttype').value)
        document.getElementById('portDialog').showModal()
      }

      window.portState = (type) => {
        console.log(type)

        let ages = Array.from(agesTable.children).slice(1).map(tr => {
          let entry = JSON.parse(tr.getAttribute('entry'))
          if (type == 'csv') {
            let ageKey = entry.key + ((entry.combo) ? ` / ${entry.combo.key}` : '')
            let ageDesc = entry.description + ((entry.combo) ? ` / ${entry.combo.description}` : '')
            let strangeKey = (entry.strange.key == "Normal") ? '' : entry.strange.key
            entry = `${ageKey}\t${strangeKey}\t${ageDesc}\t${entry.notes}`
          }
          return entry
        })

        return (type == 'csv') ? ages.join('\n') : JSON.stringify(ages)        
      }

      window.clipboardState = () => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(document.getElementById('ioTextArea').value).catch(err => {
                console.error('Failed to copy text: ', err)
                alert('Failed to copy text.')
            });
        }
      }

        localStorage.setItem('historyState', JSON.stringify(ages))

        let tr = util.getRadioSelected('ages')?.parentElement.parentElement
        if (tr) { 
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr);
          if (index) {
            localStorage.setItem('historySelected', index)

            // update next & previous tooltips
            let age = JSON.parse(tr.getAttribute('entry'))
            nextButton.setAttribute('title', `${age.key} -> ${history.leadsTo[age.key].join(' | ')}`)
            prevButton.setAttribute('title', `${history.arisesFrom[age.key].join(' | ')} -> ${age.key}`)
          } else {
            localStorage.removeItem('historySelected')
            nextButton.removeAttribute('title')
            prevButton.removeAttribute('title')
          }
        } else {
          localStorage.removeItem('historySelected')
          nextButton.removeAttribute('title')
          prevButton.removeAttribute('title')
        }
      }

      function loadState() {
        let ages = localStorage.getItem('historyState')
        let index = localStorage.getItem('historySelected')
        if (ages) {
          clearAges(false)
          JSON.parse(ages).forEach(a => { addAge(a, undefined, false, true, a.notes || '') })
          selectRadio(index)
        }
      }

      window.clearAges = (clrState=true) => {
        while (agesTable.lastChild && agesTable.childElementCount > 1) { agesTable.removeChild(agesTable.lastChild) }
        if (clrState) { 
          localStorage.removeItem('historyState')
          localStorage.removeItem('historySelected')
        }
      }

      function addAge(age, refNode=undefined, before=false, reload=false, notes='') {
        if (!age) { console.error("Invalid table result, can't add age"); return }

        age.notes = notes
        let tr = util.insertElement(agesTable, refNode, 'tr', before)
        tr.setAttribute('entry', JSON.stringify(age))

        let td = util.addElement(tr, 'td')
        util.addElement(td, util.createRadio('ages', '', !reload, saveState))

        td = util.addElement(tr, 'td')
        td.appendChild(util.createDropdown(ageList, age.key, updateAge))
        if (age.combo) {
          util.addElement(td, 'br')
          td.appendChild(util.createDropdown(ageList, age.combo.key, updateAge))
        }

        td = util.addElement(tr, 'td')
        let el = util.createDropdown(strangeList, age.strange.key, updateAge)
        td.appendChild(el)
        if (age.strange.key) {
          td.setAttribute('title', history.ageDescriptions[age.strange.key])
        }
        if (age.strange.key == "Normal") { el.style.opacity = '0.35' }


        td = util.addElement(tr, 'td', age.description)
        td.setAttribute('title', history.ageDescriptions[age.key])
        if (age.combo) {
          util.addElement(td, 'br')
          let tdc = util.addElement(td, 'td', age.combo.description)
          tdc.setAttribute('title', history.ageDescriptions[age.combo.key])
        }

        td = util.addElement(tr, 'td')
        el = document.createElement('input')
        el.setAttribute('type', 'text')
        el.setAttribute('style', 'width: 100%')
        el.value = notes
        el.addEventListener('focus', (event) => { event.target.parentElement.parentElement.firstChild.firstChild.checked = true; saveState() })
        el.addEventListener('change', saveState)
        td.appendChild(el)

        saveState()
        return tr
      }

      // don't roll strange ages
      window.noStrangeToggle = (event) => { history.noStrange = event.target.checked }

      // generate random age
      genButton.addEventListener('click', event => { addAge(history.ages()) })

      // remove selected age
      window.removeAge = () => {
        let radio = util.getRadioSelected('ages')
        if (radio) { 
          agesTable.removeChild(radio.parentElement.parentElement)
          saveState()
        }
      }

      // generate leads-to / arises-from age from selected age, append / prepend to selected age
      window.relatedAge = (event, direction) => {
        let radio = util.getRadioSelected('ages')
        if (radio) { 
          let entry = JSON.parse(radio.parentElement.parentElement.getAttribute('entry'))
          if (direction == 'to') { 
            addAge(history.ages(pick(...history.leadsTo[entry.key])), radio.parentElement.parentElement)
          }
          else if (direction == 'from') {
            addAge(history.ages(pick(...history.arisesFrom[entry.key])), radio.parentElement.parentElement, true)
          }
        }
      }

      // moves the age up or down the list
      window.shiftEntry = (move, before) => {
        let tr = util.getRadioSelected('ages')?.parentElement.parentElement
        if (tr) { 
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr) + move;
          if (index >= 1 && index <= childrenArray.length-1) {
            agesTable.removeChild(tr)
            util.insertElement(agesTable, childrenArray[index], tr, before)
          }
          saveState()
        }
      }

      function updateAge(event) {
        let tr = event.target.parentElement.parentElement
        let index = localStorage.getItem('historySelected')

        let age = tr.children[1].firstChild.value
        let strange = tr.children[2].firstChild.value || "Normal"
        let combo = tr.children[1].lastChild.value
        age = history.ages(age, strange, combo)
        let notes = tr.lastChild.firstChild.value || ''

        // create updated age entry, remove original age entry, reset selected radio
        addAge(age, tr, false, false, notes)

        agesTable.removeChild(tr)
        selectRadio(index)

        saveState()
      }

      function selectRadio(index) {
        const childrenArray = Array.from(agesTable.children);
        if (index && index < childrenArray.length) {
          childrenArray[index].firstChild.firstChild.checked = true
        }
        saveState()
      }

      window.rollEvent = (event) => {
        let e = history.events.pick()
        document.getElementById('eventSpan').textContent = e.key.replace('_', ' ')
        document.getElementById('eventDescLi').textContent = e.description
        document.getElementById('eventDescLi').parentElement.hidden = false
        document.getElementById('eventSpan').parentElement.children[0].disabled = false
      }

      window.rollCrisis = (event) => {
        Array.from(document.getElementsByClassName('crisisButtons')).forEach(b => b.disabled = false);
        document.getElementById('crisisSpan').textContent = history.crises.pick().description
        document.getElementById('overcomeSpan').textContent = history.crisisOvercome.pick().description
        document.getElementById('failSpan').textContent = history.crisisFailed.pick().description
      }

      window.getTag = (source) => {
        return document.getElementById(source).textContent
      }

      window.copyTag = (text) => {
        let tr = util.getRadioSelected('ages')?.parentElement.parentElement
        if (tr && text) {
          if (tr.lastChild.firstChild.value) { tr.lastChild.firstChild.value += ', ' }
          tr.lastChild.firstChild.value += text
          saveState()
        }
      }

      // load state on page load
      loadState()
    </script>

  </body>
</html>
