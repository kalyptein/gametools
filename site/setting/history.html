<html>
  <head>
    <title>Ages of History</title>
  </head>
  <body>
    <h1>Ages of History</h1>

    <p style="background: lightgrey; position: fixed; width: 100%; top: 50px; padding: 5px">
      <button id="genButton" style="width:80px">Append</button>
      <button id="upButton" style="width:30px">▲</button>
      <button id="downButton" style="width:30px">▼</button>
      <button id="nextButton" style="width:80px">Next</button>
      <button id="prevButton" style="width:80px">Previous</button>
      <button id="rmButton" style="width:80px">Remove</button>
      <button id="clrButton" style="width:80px">Clear</button>
      <input type="checkbox" id="noStrangeCheck" value="false" />No Strange
    </p>

    <table id="agesTable" style="border: 1px solid; margin-top: 70px; border-spacing: 2px 4px">
      <tr style="background: black; color: white">
        <th style="width:30px; padding: 5px"></th>
        <th style="width:100px; text-align: start; padding: 5px">Age</th>
        <th style="width:500px; text-align: start; padding: 5px">Description</th>
      </tr>
    </table>

    <script type="module" defer>

      import { m, d, pick, Table, tables, addElement, insertElement, getRadioSelected, createDropdown, createRadio } from "../scripts/utils.js"
      import { history, ageList, strangeList } from "./history.js"

      // get elements
      const agesTable = document.getElementById("agesTable")
      const genButton = document.getElementById("genButton")
      const upButton = document.getElementById("upButton")
      const downButton = document.getElementById("downButton")
      const rmButton = document.getElementById("rmButton")
      const clrButton = document.getElementById("clrButton")
      const nextButton = document.getElementById("nextButton")
      const prevButton = document.getElementById("prevButton")
      const noStrangeCheck = document.getElementById("noStrangeCheck")

      function saveState() {
        const ages = Array.from(agesTable.children).slice(1).map(a => a.getAttribute('entry'))
        localStorage.setItem('historyState', JSON.stringify(ages))

        let radio = getRadioSelected('ages')
        if (radio) { 
          let tr = radio.parentElement.parentElement
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr);
          localStorage.setItem('historySelected', index)
        }
      }

      function loadState() {
        let ages = localStorage.getItem('historyState')
        if (ages) {
          let index = localStorage.getItem('historySelected')
          clearAges(false)
          JSON.parse(ages).map(a => JSON.parse(a)).forEach(a => addAge(a))
          if (index != null) { selectRadio(index) }

        }
      }

      function clearAges(clrState=true) {
        while (agesTable.lastChild && agesTable.childElementCount > 1) {
          agesTable.removeChild(agesTable.lastChild)
        }
        if (clrState) { localStorage.removeItem('historyState') }
      }

      function addAge(age, refNode=undefined, before=false) {
        if (!age) { console.error("Invalid table result, can't add age"); return }
        let tr = insertElement(agesTable, refNode, 'tr', before)
        tr.setAttribute('entry', JSON.stringify(age))

        let td = addElement(tr, 'td')
        let el = createRadio('ages', '', true)
        el.setAttribute('ageType', age.key)
        td.appendChild(el)
        el.addEventListener('change', saveSelectedRadio);

        td = addElement(tr, 'td')
        td.appendChild(createDropdown(ageList, age.key, setDescription))

        let desc = (age.key == "Strange") ? `*** ${age.description} ***` : age.description
        td = addElement(tr, 'td', desc)

        if (age.key == "Strange") {
          let sub_tr = addAge(history.ages(d(18)), tr)
          if (age.description == "Combo") { addAge(history.ages(d(18)), sub_tr) }
        }

        saveState()
        return tr
      }

      // don't roll strange ages
      noStrangeCheck.addEventListener('click', event => { history.noStrange = event.target.checked })

      // generate random age
      genButton.addEventListener('click', event => { addAge(history.ages()) })

      // remove selected age
      rmButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          agesTable.removeChild(radio.parentElement.parentElement)
          saveState()
        }
      })

      // clear age list
      clrButton.addEventListener('click', event => {
        if (window.confirm("Clear List?")) { clearAges() }
      })

      // generate leads-to age from selected age, append to selected age
      nextButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let type = radio.getAttribute('ageType')
          let age = history.leadsTo[type]()
          addAge(age, radio.parentElement.parentElement)
        }
      })

      // generate arises-from age from selected age, prepend to selected age
      prevButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let type = radio.getAttribute('ageType')
          let age = history.arisesFrom[type]()
          addAge(age, radio.parentElement.parentElement, true)
        }
      })

      function shiftEntry(move, before) {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let tr = radio.parentElement.parentElement
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr) + move;
          if (index >= 1 && index <= childrenArray.length-1) {
            agesTable.removeChild(tr)
            insertElement(agesTable, childrenArray[index], tr, before)
          }
          saveState()
        }
      }

      upButton.addEventListener('click', event => shiftEntry(-1, true))
      downButton.addEventListener('click', event => shiftEntry(1, false))

      function setDescription(event) {
        let tr = event.target.parentElement.parentElement
        let age = history.ages(event.target.value)
        tr.setAttribute('entry', JSON.stringify(age))
        let desc = (age.key == "Strange") ? `*** ${age.description} ***` : age.description
        tr.children[tr.childElementCount-1].textContent = desc
        saveState()
      }

      function saveSelectedRadio() {
        const childrenArray = Array.from(agesTable.children);
        let index = childrenArray.indexOf(getRadioSelected('ages').parentElement.parentElement);
        localStorage.setItem('historySelected', index)
      }

      function selectRadio(index) {
        const childrenArray = Array.from(agesTable.children);
        childrenArray[index].firstChild.firstChild.checked = true;
        saveSelectedRadio()
      }

      // load state on page load
      loadState()
    </script>

  </body>
</html>
