<html>
  <head>
    <title>Ages of History</title>
    <style>
      tr:nth-child(odd) {
        background-color: lightgrey; /* Light grey for odd rows */
      }

      /* tr:nth-child(even) {
        background-color: white; /* White for even rows
      } */

      th {
        text-align: start;
        padding: 5px
      }

      .container {
        display: flex
      }

      /* .column {
        flex: 1
      } */
    </style>
  </head>
  <body>
    <h1>History</h1>

    <div class="container">

      <div class="column" style="width: 55%">
        <h2>Ages of History</h2>
        
        <p style="background: lightgrey; padding: 5px;">
          <button id="genButton" style="width:80px">Append</button>
          <button id="upButton" style="width:30px" onclick="shiftEntry(-1, true)">▲</button>
          <button id="downButton" style="width:30px" onclick="shiftEntry(1, false)">▼</button>
          <button id="nextButton" style="width:80px">Next</button>
          <button id="prevButton" style="width:80px">Previous</button>
          <button id="rmButton" style="width:80px">Remove</button>
          <button id="clrButton" style="width:80px" onclick="if (confirm('Clear List?')) { clearAges() }">Clear</button>
          <input type="checkbox" id="noStrangeCheck" value="false" onclick="noStrangeToggle(event)"/>No Strange
          <!-- TODO button export to json and/or text for each copying -->
        </p>

        <table id="agesTable" style="border: 1px solid; border-spacing: 2px 4px">
          <tr style="background: black; color: white">
            <th style="width:30px;"></th>
            <th style="width:100px;">Age</th>
            <th style="width:500px;">Description</th>
            <th style="width:500px;">Notes</th>
          </tr>
        </table>
      </div>

      <div class="column" style="width: 40%; margin-left: 50px">
        <h2>Historical Events</h2>

        <p style="background: lightgrey; padding: 5px;">
          <button id="eventButton" style="width:80px" onclick="rollEvent();">Event</button>
          <button id="crisisButton" style="width:80px" onclick="rollCrisis();">Crisis</button>
        </p>

        <ul>
          <li>Event: <span id="eventSpan"></span></li>
          <ul hidden>
            <li id="eventDescLi"></li>
          </ul>
          <li>Crisis: <span id="crisisLi"></span></li>
          <ul>
            <li>Overcome: <span id="overcomeLi"></span></li>
            <li>Failed: <span id="failLi"></span></li>
          </ul>
        </ul>
      </div>

    </div>

    <script type="module" defer>

      import { m, d, pick, Table, tables, addElement, insertElement, getRadioSelected, createDropdown, createRadio } from "../scripts/utils.js"
      import { history, ageList, strangeList } from "./history.js"

      // get elements
      const agesTable = document.getElementById("agesTable")
      const genButton = document.getElementById("genButton")
      const rmButton = document.getElementById("rmButton")
      const nextButton = document.getElementById("nextButton")
      const prevButton = document.getElementById("prevButton")

      // TODO
      //
      // put table / odds in tooltip(s)
      //
      // notes for ages, button to copy events/crises to notes

      function saveState() {
        const ages = Array.from(agesTable.children).slice(1).map(a => a.getAttribute('entry'))
        localStorage.setItem('historyState', JSON.stringify(ages))

        let radio = getRadioSelected('ages')
        if (radio) { 
          let tr = radio.parentElement.parentElement
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr);
          localStorage.setItem('historySelected', index)
        }
      }

      function loadState() {
        let ages = localStorage.getItem('historyState')
        if (ages) {
          let index = localStorage.getItem('historySelected')
          clearAges(false)
          JSON.parse(ages).map(a => JSON.parse(a)).forEach(a => addAge(a, undefined, false, true))
          if (index != null) { selectRadio(index) }
        }
      }

      window.clearAges = (clrState=true) => {
        while (agesTable.lastChild && agesTable.childElementCount > 1) { agesTable.removeChild(agesTable.lastChild) }
        if (clrState) { localStorage.removeItem('historyState') }
      }

      function addAge(age, refNode=undefined, before=false, reload=false) {
        if (!age) { console.error("Invalid table result, can't add age"); return }
        let tr = insertElement(agesTable, refNode, 'tr', before)
        tr.setAttribute('entry', JSON.stringify(age))

        let td = addElement(tr, 'td')
        let el = createRadio('ages', '', !reload)
        el.setAttribute('ageType', age.key)
        td.appendChild(el)
        el.addEventListener('change', saveSelectedRadio);

        td = addElement(tr, 'td')
        td.appendChild(createDropdown(ageList, age.key, setDescription))

        if (age.key != "Strange") {
          td = addElement(tr, 'td', age.description)

          td = addElement(tr, 'td')
          el = document.createElement('input')
          el.setAttribute('type', 'text')
          el.setAttribute('style', 'width: 100%')
          td.appendChild(el)
        } else {
          td = addElement(tr, 'td')
          addElement(td, createDropdown(strangeList, age.description))
        }

        if (age.key == "Strange" && !reload) {
          let sub_tr = addAge(history.ages(d(18)), tr)
          if (age.description == "Combo") { addAge(history.ages(d(18)), sub_tr) }
        }

        saveState()
        return tr
      }

      // don't roll strange ages
      window.noStrangeToggle = (event) => { history.noStrange = event.target.checked }

      // generate random age
      genButton.addEventListener('click', event => { addAge(history.ages()) })

      // remove selected age
      rmButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          agesTable.removeChild(radio.parentElement.parentElement)
          saveState()
        }
      })

      // generate leads-to age from selected age, append to selected age
      nextButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let type = radio.getAttribute('ageType')
          let age = history.leadsTo[type]()
          addAge(age, radio.parentElement.parentElement)
        }
      })

      // generate arises-from age from selected age, prepend to selected age
      prevButton.addEventListener('click', event => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let type = radio.getAttribute('ageType')
          let age = history.arisesFrom[type]()
          addAge(age, radio.parentElement.parentElement, true)
        }
      })

      window.shiftEntry = (move, before) => {
        let radio = getRadioSelected('ages')
        if (radio) { 
          let tr = radio.parentElement.parentElement
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr) + move;
          if (index >= 1 && index <= childrenArray.length-1) {
            agesTable.removeChild(tr)
            insertElement(agesTable, childrenArray[index], tr, before)
          }
          saveState()
        }
      }

      function setDescription(event) {
        let tr = event.target.parentElement.parentElement
        let age = history.ages(event.target.value)
        tr.setAttribute('entry', JSON.stringify(age))
        tr.children[tr.childElementCount-2].textContent = age.description
        saveState()
      }

      function saveSelectedRadio() {
        const childrenArray = Array.from(agesTable.children);
        let index = childrenArray.indexOf(getRadioSelected('ages').parentElement.parentElement);
        if (index) {
          localStorage.setItem('historySelected', index)
        } else {
          localStorage.removeItem('historySelected')
        }
      }

      function selectRadio(index) {
        const childrenArray = Array.from(agesTable.children);
        if (index < childrenArray.length) { childrenArray[index].firstChild.firstChild.checked = true; }
        saveSelectedRadio()
      }

      window.rollEvent = () => {
        let e = history.events.pick()
        document.getElementById('eventSpan').textContent = e.key.replace('_', ' ')
        document.getElementById('eventDescLi').textContent = e.description
        document.getElementById('eventDescLi').parentElement.hidden = false
      }

      window.rollCrisis = () => {
        document.getElementById('crisisLi').textContent = history.crises.pick().description
        document.getElementById('overcomeLi').textContent = history.crisisOvercome.pick().description
        document.getElementById('failLi').textContent = history.crisisFailed.pick().description
      }

      // load state on page load
      loadState()
    </script>

  </body>
</html>
