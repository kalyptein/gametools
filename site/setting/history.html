<html>
  <head>
    <title>Ages of History</title>
    <style>
      tr:nth-child(odd) {
        background-color: lightgrey; /* Light grey for odd rows */
      }

      /* tr:nth-child(even) {
        background-color: white; /* White for even rows
      } */

      th {
        text-align: start;
        padding: 5px
      }

      .container {
        display: flex
      }

      /* .column {
        flex: 1
      } */
    </style>
  </head>
  <body>
    <h1>History</h1>

    Seed: <input type="text" id="seedText"></input>

    <div class="container">

      <div class="column" style="width: 55%">
        <h2>Ages of History</h2>
        
        <p style="background: lightgrey; padding: 5px;">
          <button id="genButton" style="width:80px">Append</button>
          <button id="upButton" style="width:30px" onclick="shiftEntry(-1, true)">▲</button>
          <button id="downButton" style="width:30px" onclick="shiftEntry(1, false)">▼</button>
          <button id="nextButton" style="width:80px" onclick="relatedAge(event, 'to')">Next</button>
          <button id="prevButton" style="width:80px" onclick="relatedAge(event, 'from')">Previous</button>
          <button id="rmButton" style="width:80px">Remove</button>
          <button id="clrButton" style="width:80px" onclick="if (confirm('Clear List?')) { clearAges() }">Clear</button>
          <input type="checkbox" id="noStrangeCheck" value="false" onclick="noStrangeToggle(event)"/>No Strange
          <!-- TODO button export to json and/or text for each copying -->
        </p>

        <table id="agesTable" style="border: 1px solid; border-spacing: 2px 4px">
          <tr style="background: black; color: white">
            <th style="width:30px;"></th>
            <th style="width:100px;">Age</th>
            <th style="width:100px;"></th>
            <th style="width:500px;">Description</th>
            <th style="width:500px;">Notes</th>
          </tr>
        </table>
      </div>

      <div class="column" style="width: 40%; margin-left: 50px">
        <h2>Historical Events</h2>

        <p style="background: lightgrey; padding: 5px;">
          <button id="eventButton" style="width:80px" onclick="rollEvent();">Event</button>
          <button id="crisisButton" style="width:80px" onclick="rollCrisis();">Crisis</button>
        </p>

        <ul>
          <li>Event: <span id="eventSpan"></span></li>
          <ul hidden>
            <li id="eventDescLi"></li>
          </ul>
          <li>Crisis: <span id="crisisLi"></span></li>
          <ul>
            <li>Overcome: <span id="overcomeLi"></span></li>
            <li>Failed: <span id="failLi"></span></li>
          </ul>
        </ul>
      </div>

    </div>

    <script type="module" defer>

      import * as util from "../scripts/utils.js"
      import { tables } from "../scripts/utils.js"
      import { history, ageList, strangeList } from "./history.js"

      const seedText = document.getElementById("seedText")
      seedText.value = util.m.seed
      seedText.addEventListener('change', event => { util.seed(Number(seedText.value)) })

      // get elements
      const agesTable = document.getElementById("agesTable")
      const genButton = document.getElementById("genButton")
      const rmButton = document.getElementById("rmButton")
      const nextButton = document.getElementById("nextButton")
      const prevButton = document.getElementById("prevButton")

      let ha = tables['historical-ages']
      let genTooltip = `range: ${ha.indexRange}\n`
      ha.content.forEach(a => genTooltip += `${String(a.index).padEnd(10)}\t${a.key.padEnd(20)}${a.description}\n`)
      genButton.setAttribute('title', genTooltip)

      // TODO
      //
      // put table odds in tooltip(s) for leads-to and arises-from
      //
      // notes for ages (save state), button to copy events/crises to notes
      //
      // for strange ages, make the type use the leads-to/arises-from list, except for discontinuity and the second half of combo
      //
      // Tooltip of age details on mouseover of age type

      function saveState() {
        const ages = Array.from(agesTable.children).slice(1).map(a => a.getAttribute('entry'))
        localStorage.setItem('historyState', JSON.stringify(ages))

        let tr = util.getRadioSelected('ages')?.parentElement.parentElement
        if (tr) { 
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr);
          if (index) {
            localStorage.setItem('historySelected', index)
          } else {
            localStorage.removeItem('historySelected')
          }
        }
      }

      function loadState() {
        let ages = localStorage.getItem('historyState')
        if (ages) {
          clearAges(false)
          JSON.parse(ages).map(a => JSON.parse(a)).forEach(a => addAge(a, undefined, false, true))
          selectRadio(localStorage.getItem('historySelected'))
        }
      }

      window.clearAges = (clrState=true) => {
        while (agesTable.lastChild && agesTable.childElementCount > 1) { agesTable.removeChild(agesTable.lastChild) }
        if (clrState) { localStorage.removeItem('historyState') }
      }

      function addAge(age, refNode=undefined, before=false, reload=false) {
        if (!age) { console.error("Invalid table result, can't add age"); return }
        let tr = util.insertElement(agesTable, refNode, 'tr', before)
        tr.setAttribute('entry', JSON.stringify(age))

        let td = util.addElement(tr, 'td')
        util.addElement(td, util.createRadio('ages', '', !reload, saveState))

        td = util.addElement(tr, 'td')
        td.appendChild(util.createDropdown(ageList, age.key, updateAge))
        if (age.combo) {
          util.addElement(td, 'br')
          td.appendChild(util.createDropdown(ageList, age.combo.key, updateAge))
        }

        td = util.addElement(tr, 'td')
        td.appendChild(util.createDropdown(strangeList, age.strange.key, updateAge))

        td = util.addElement(tr, 'td', age.description)
        if (age.combo) {
          util.addElement(td, 'br')
          util.addElement(td, 'td', age.combo.description)
        }

        td = util.addElement(tr, 'td')
        let el = document.createElement('input')
        el.setAttribute('type', 'text')
        el.setAttribute('style', 'width: 100%')
        td.appendChild(el)

        saveState()
        return tr
      }

      // don't roll strange ages
      window.noStrangeToggle = (event) => { history.noStrange = event.target.checked }

      // generate random age
      genButton.addEventListener('click', event => { addAge(history.ages()) })

      // remove selected age
      rmButton.addEventListener('click', event => {
        let radio = util.getRadioSelected('ages')
        if (radio) { 
          agesTable.removeChild(radio.parentElement.parentElement)
          saveState()
        }
      })

      // generate leads-to / arises-from age from selected age, append / prepend to selected age
      window.relatedAge = (event, direction) => {
        let radio = util.getRadioSelected('ages')
        if (radio) { 
          let entry = JSON.parse(radio.parentElement.parentElement.getAttribute('entry'))
          if (direction == 'to') { addAge(history.leadsTo[entry.key](), radio.parentElement.parentElement) }
          else if (direction == 'from') { addAge(history.arisesFrom[entry.key](), radio.parentElement.parentElement, true) }
        }
      }

      // moves the age up or down the list
      window.shiftEntry = (move, before) => {
        let tr = util.getRadioSelected('ages')?.parentElement.parentElement
        if (tr) { 
          const childrenArray = Array.from(agesTable.children);
          let index = childrenArray.indexOf(tr) + move;
          if (index >= 1 && index <= childrenArray.length-1) {
            agesTable.removeChild(tr)
            util.insertElement(agesTable, childrenArray[index], tr, before)
          }
          saveState()
        }
      }

      function updateAge(event) {
        let tr = event.target.parentElement.parentElement
        let index = localStorage.getItem('historySelected')

        let age = tr.children[1].firstChild.value
        let strange = tr.children[2].firstChild.value || "Normal"
        let combo = tr.children[1].lastChild.value
        age = history.ages(age, strange, combo)

        // create updated age entry, remove original age entry, reset selected radio
        addAge(age, tr)
        agesTable.removeChild(tr)
        selectRadio(index)

        saveState()
      }

      function selectRadio(index) {
        const childrenArray = Array.from(agesTable.children);
        if (index && index < childrenArray.length) {
          childrenArray[index].firstChild.firstChild.checked = true
        }
        saveState()
      }

      window.rollEvent = () => {
        let e = history.events.pick()
        document.getElementById('eventSpan').textContent = e.key.replace('_', ' ')
        document.getElementById('eventDescLi').textContent = e.description
        document.getElementById('eventDescLi').parentElement.hidden = false
      }

      window.rollCrisis = () => {
        document.getElementById('crisisLi').textContent = history.crises.pick().description
        document.getElementById('overcomeLi').textContent = history.crisisOvercome.pick().description
        document.getElementById('failLi').textContent = history.crisisFailed.pick().description
      }

      // load state on page load
      loadState()
    </script>

  </body>
</html>
